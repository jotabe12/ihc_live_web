<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-885Y98NZ72"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-885Y98NZ72');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario - ViviEstu</title>
    <link rel="stylesheet" href="../css/perfil_usuario.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="logo-container">
        <a href="../index.html">
            <img src="../asset/Logo.png" alt="ViviEstu Logo" class="logo" style="cursor: pointer;">
        </a>
    </div>
    <nav class="nav-menu">
        <a href="../index.html">Inicio</a>
        <a href="mapa_seguridad.html">Zonas</a>
        <a href="catalogo.html">Cat√°logo</a>
        <a href="foro_estudiantil.html">Comunidad</a>
    </nav>
    <div class="nav-buttons">
        <button class="btn-login" id="btnLoginDesktop">Iniciar Sesi√≥n</button>
        <button class="btn-register" id="btnRegisterDesktop">Registrarse</button>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="container">
        <!-- Greeting -->
        <h1 class="greeting">Hola, <strong id="greetingName">Nombre</strong></h1>

        <!-- Profile Card -->
        <div class="profile-card">
            <div class="profile-image-container">
                <div class="profile-image">
                    <i class="fas fa-user"></i>
                </div>
            </div>
            <h2 class="profile-name" id="profileName">Nombre Completo</h2>
            <div class="profile-buttons">
                <button class="btn-profile" id="btnEditarPerfil">Editar perfil</button>
                <button class="btn-profile" onclick="alert('Funcionalidad de subir foto pr√≥ximamente')">Subir foto</button>
            </div>
        </div>

        <!-- Modal para editar nombre -->
        <div id="modalEditarNombre" class="modal-editar">
            <div class="modal-editar-content">
                <span class="modal-close">&times;</span>
                <h2>Editar Nombre de Usuario</h2>
                <form id="formEditarNombre">
                    <div class="form-group">
                        <label for="nuevoNombre">Nuevo nombre:</label>
                        <input type="text" id="nuevoNombre" placeholder="Ingresa tu nuevo nombre" required>
                    </div>
                    <p id="mensajeErrorEdicion" class="mensaje-error"></p>
                    <div class="modal-buttons">
                        <button type="button" class="btn-cancelar" id="btnCancelar">Cancelar</button>
                        <button type="submit" class="btn-guardar">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Activity Sections -->
        <div class="activity-section">
            <div class="section-header">
                <h3 class="section-title">Reservas completadas</h3>
                <a href="agendar_visita.html" class="ver-todo">ver todo</a>
            </div>
            <div class="section-content" id="reservas-perfil-content">
                <p class="no-reservas">No tienes reservas a√∫n</p>
            </div>
        </div>

        <div class="activity-section">
            <div class="section-header">
                <h3 class="section-title">Rese√±as de Viviendas</h3>
                <a href="foro_estudiantil.html" class="ver-todo">ver todas</a>
            </div>
            <div class="section-content" id="resenas-perfil-content">
                <p class="no-reservas">No tienes rese√±as a√∫n</p>
            </div>
        </div>

        <div class="activity-section">
            <div class="section-header">
                <h3 class="section-title">Comentarios en el Foro</h3>
                <a href="foro_estudiantil.html" class="ver-todo">ver todos</a>
            </div>
            <div class="section-content" id="comentarios-perfil-content">
                <p class="no-reservas">No tienes comentarios a√∫n</p>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-left">
            <div class="footer-section">
                <h4>Nosotros</h4>
                <p>ViviEstu es tu plataforma confiable para encontrar el alojamiento perfecto durante tus estudios.</p>
            </div>

            <div class="footer-section">
                <h4>Centro de Ayuda</h4>
                <ul>
                    <li><a href="#">Preguntas Frecuentes</a></li>
                    <li><a href="#">T√©rminos y Condiciones</a></li>
                    <li><a href="#">Pol√≠ticas de Privacidad</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h4>Cont√°ctanos</h4>
                <ul>
                    <li><i class="fas fa-envelope"></i> info@viviestu.com</li>
                    <li><i class="fas fa-phone"></i> +51 999 999 999</li>
                    <li><i class="fas fa-map-marker-alt"></i> Lima, Per√∫</li>
                </ul>
            </div>
        </div>

        <div class="footer-right">
            <h2 class="footer-brand">ViviEstu</h2>
            <p class="footer-tagline">Tu hogar mientras estudias</p>
            <div class="social-links">
                <a href="#" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
                <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2025 ViviEstu. Todos los derechos reservados.</p>
    </div>
</footer>

<script src="../js/app.js"></script>
<script>
// Proteger p√°gina - solo accesible con sesi√≥n
SessionManager.protectPage();

// Cargar datos del usuario
document.addEventListener('DOMContentLoaded', function() {
    const user = SessionManager.getUser();

    if (user) {
        // Actualizar nombre en el saludo y perfil
        document.getElementById('greetingName').textContent = user.nombre;
        document.getElementById('profileName').textContent = user.nombre;
    }

    // ==========================================
    // MODAL EDITAR NOMBRE
    // ==========================================
    const modal = document.getElementById('modalEditarNombre');
    const btnEditar = document.getElementById('btnEditarPerfil');
    const btnCerrar = document.querySelector('.modal-close');
    const btnCancelar = document.getElementById('btnCancelar');
    const formEditar = document.getElementById('formEditarNombre');
    const inputNuevoNombre = document.getElementById('nuevoNombre');
    const mensajeError = document.getElementById('mensajeErrorEdicion');

    // Abrir modal
    btnEditar.addEventListener('click', function() {
        if (user) {
            inputNuevoNombre.value = user.nombre; // Pre-llenar con el nombre actual
            mensajeError.textContent = '';
            mensajeError.style.display = 'none';
            modal.style.display = 'block';
        }
    });

    // Cerrar modal con X
    btnCerrar.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    // Cerrar modal con bot√≥n Cancelar
    btnCancelar.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    // Cerrar modal al hacer clic fuera de √©l
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Manejar env√≠o del formulario
    formEditar.addEventListener('submit', function(e) {
        e.preventDefault();

        const nuevoNombre = inputNuevoNombre.value.trim();

        // Validar que el nombre no est√© vac√≠o
        if (!nuevoNombre) {
            mensajeError.textContent = 'El nombre no puede estar vac√≠o';
            mensajeError.style.display = 'block';
            return;
        }

        // Validar longitud m√≠nima
        if (nuevoNombre.length < 2) {
            mensajeError.textContent = 'El nombre debe tener al menos 2 caracteres';
            mensajeError.style.display = 'block';
            return;
        }

        // Actualizar el nombre del usuario
        const actualizado = SessionManager.updateUserName(nuevoNombre);

        if (actualizado) {
            // Actualizar la interfaz
            document.getElementById('greetingName').textContent = nuevoNombre;
            document.getElementById('profileName').textContent = nuevoNombre;

            // Actualizar el header (nombre en dropdown)
            HeaderManager.updateHeader();

            // Cerrar modal
            modal.style.display = 'none';

            // Mostrar mensaje de √©xito
            alert('¬°Nombre actualizado exitosamente!');
        } else {
            mensajeError.textContent = 'Error al actualizar el nombre';
            mensajeError.style.display = 'block';
        }
    });

    // ==========================================
    // CARGAR RESERVAS DEL USUARIO
    // ==========================================
    function cargarReservasPerfil() {
        const allReservations = JSON.parse(localStorage.getItem("reservas")) || {};
        const userReservations = allReservations[user.email] || [];

        const reservasContainer = document.getElementById('reservas-perfil-content');

        if (userReservations.length === 0) {
            reservasContainer.innerHTML = '<p class="no-reservas">No tienes reservas a√∫n</p>';
            return;
        }

        // Mostrar √∫ltimas 3 reservas
        const ultimasReservas = userReservations.slice(-3).reverse();

        reservasContainer.innerHTML = ultimasReservas.map(reserva => `
            <div class="reserva-item">
                <p><strong>üìç ${reserva.inmueble}</strong></p>
                <p>üìÖ ${reserva.fechaFormateada} - ‚è∞ ${reserva.hora}</p>
                <p>üí∞ S/ ${reserva.inmueblePrecio}</p>
            </div>
        `).join('');

        // Agregar contador
        const sectionHeader = reservasContainer.previousElementSibling;
        const verTodoLink = sectionHeader.querySelector('.ver-todo');
        if (verTodoLink) {
            verTodoLink.textContent = `ver todas (${userReservations.length})`;
        }
    }

    // Cargar reservas al iniciar
    cargarReservasPerfil();

    // ==========================================
    // CARGAR RESE√ëAS DEL USUARIO
    // ==========================================
    function cargarResenasPerfil() {
        const interacciones = JSON.parse(localStorage.getItem("userInteracciones")) || {};
        const userInteracciones = interacciones[user.email] || { resenas: [], comentarios: [] };
        const resenasContainer = document.getElementById('resenas-perfil-content');

        if (userInteracciones.resenas.length === 0) {
            resenasContainer.innerHTML = '<p class="no-reservas">No tienes rese√±as a√∫n</p>';
            return;
        }

        // Mostrar √∫ltimas 3 rese√±as
        const ultimasResenas = userInteracciones.resenas.slice(-3).reverse();

        resenasContainer.innerHTML = ultimasResenas.map(resena => {
            const stars = Array(resena.rating).fill('‚≠ê').join('');
            return `
                <div class="reserva-item" style="cursor: pointer;" onclick="window.location.href='foro_estudiantil.html'">
                    <p><strong>üè† ${resena.vivienda.nombre}</strong></p>
                    <p>${stars} (${resena.rating}/5)</p>
                    <p style="font-size: 0.9rem; color: #666;">${resena.texto.substring(0, 60)}${resena.texto.length > 60 ? '...' : ''}</p>
                    <small style="color: #888;">üìÖ ${resena.fecha}</small>
                </div>
            `;
        }).join('');

        // Agregar contador
        const sectionHeader = resenasContainer.previousElementSibling;
        const verTodoLink = sectionHeader.querySelector('.ver-todo');
        if (verTodoLink) {
            verTodoLink.textContent = `ver todas (${userInteracciones.resenas.length})`;
        }
    }

    // ==========================================
    // CARGAR COMENTARIOS DEL USUARIO
    // ==========================================
    function cargarComentariosPerfil() {
        const interacciones = JSON.parse(localStorage.getItem("userInteracciones")) || {};
        const userInteracciones = interacciones[user.email] || { resenas: [], comentarios: [] };
        const comentariosContainer = document.getElementById('comentarios-perfil-content');

        if (userInteracciones.comentarios.length === 0) {
            comentariosContainer.innerHTML = '<p class="no-reservas">No tienes comentarios a√∫n</p>';
            return;
        }

        // Mostrar √∫ltimos 3 comentarios
        const ultimosComentarios = userInteracciones.comentarios.slice(-3).reverse();

        comentariosContainer.innerHTML = ultimosComentarios.map(comentario => `
            <div class="reserva-item" style="cursor: pointer;" onclick="window.location.href='foro_estudiantil.html'">
                <p><strong>üí¨ ${comentario.ubicacion}</strong></p>
                <p style="font-size: 0.9rem; color: #666;">${comentario.texto.substring(0, 80)}${comentario.texto.length > 80 ? '...' : ''}</p>
                <small style="color: #888;">üìÖ ${comentario.fecha}</small>
            </div>
        `).join('');

        // Agregar contador
        const sectionHeader = comentariosContainer.previousElementSibling;
        const verTodoLink = sectionHeader.querySelector('.ver-todo');
        if (verTodoLink) {
            verTodoLink.textContent = `ver todos (${userInteracciones.comentarios.length})`;
        }
    }

    // Cargar rese√±as y comentarios al iniciar
    cargarResenasPerfil();
    cargarComentariosPerfil();
});
</script>
</body>
</html>

